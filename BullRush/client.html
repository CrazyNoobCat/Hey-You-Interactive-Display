<!DOCTYPE html>
<html>
  <head>
    <title>Bull Rush Client | Hey You Interactive Display</title>
    <link rel="stylesheet" href="client.css">

    <style>
        .arrow {
            position: relative;
            display: inline-block;
            width: 49%;
        }

        .inner {
          margin: auto;
          width: 75%;
        }

        .dot {
          height: 150px;
          width: 150px;
          border-radius: 50%;
          margin: auto; 
          position: absolute; 
          left: 0px; 
          top: 0px; 
          right: 0px; 
          bottom: 0px;
        }
    </style>

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous">
    </script>
    <script> 
    $(function(){
      $("#header").load("header.html"); 
      $("#footer").load("footer.html"); 
    });
    </script> 
  </head>
  <body>
    <div class="container">
      <div id="header"></div>

    
      <div id="stick1" class="dot"></div>
    
    <script src="/socketCreation.js"></script>
    <script>
      // Generic socket setup
      setupConnection("client");  

      console.log(roomID);
      console.log(socket);

      // page specific functions
      var form = document.getElementById('form');
      var input = document.getElementById('input');

      document.addEventListener('keydown', buttondown, false);
      document.addEventListener('keyup', buttonup, false);

      function socketLoaded(){
        socket.emit('clientConnected')

        socket.on('playerColour', (colour) =>{
          console.log("Setting colour to: " + colour);
          document.getElementsByClassName("dot")[0].style.backgroundColor = colour;
        });
      }
      

      var left = document.getElementById('left');
      var right = document.getElementById('right');
   
      ///////////////////////////////////////////////////////////////////////   
      class JoystickController
      {
        // stickID: ID of HTML element (representing joystick) that will be dragged
        // maxDistance: maximum amount joystick can move in any direction
        // deadzone: joystick must move at least this amount from origin to register value change
        constructor( stickID, maxDistance, deadzone )
        {
          this.left = false;
          this.right = false;
          this.up = false;
          this.down = false;
          this.id = stickID;
          let stick = document.getElementById(stickID);

          // location from which drag begins, used to calculate offsets
          this.dragStart = null;

          // track touch identifier in case multiple joysticks present
          this.touchId = null;
          
          this.active = false;
          this.value = { x: 0, y: 0 }; 
              this.xPlace = 0;
              this.yPlace = 0;

          let self = this;

          function handleDown(event)
          {
              self.active = true;

            // all drag movements are instantaneous
            stick.style.transition = '0s';

            // touch event fired before mouse event; prevent redundant mouse event from firing
            event.preventDefault();

              if (event.changedTouches)
                self.dragStart = { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
              else
                self.dragStart = { x: event.clientX, y: event.clientY };

            // if this is a touch event, keep track of which one
              if (event.changedTouches)
                self.touchId = event.changedTouches[0].identifier;
          }
          
          function handleMove(event) 
          {
              if ( !self.active ) return;

              // if this is a touch event, make sure it is the right one
              // also handle multiple simultaneous touchmove events
              let touchmoveId = null;
              if (event.changedTouches)
              {
                for (let i = 0; i < event.changedTouches.length; i++)
                {
                  if (self.touchId == event.changedTouches[i].identifier)
                  {
                    touchmoveId = i;
                    event.clientX = event.changedTouches[i].clientX;
                    event.clientY = event.changedTouches[i].clientY;
                  }
                }

                if (touchmoveId == null) return;
              }

              const xDiff = event.clientX - self.dragStart.x;
              const yDiff = event.clientY - self.dragStart.y;
              const angle = Math.atan2(yDiff, xDiff);
              const distance = Math.min(maxDistance, Math.hypot(xDiff, yDiff));
              const xPosition = distance * Math.cos(angle);
              const yPosition = distance * Math.sin(angle);

              // move stick image to new position
              stick.style.transform = `translate3d(${xPosition}px, ${yPosition}px, 0px)`;

              // deadzone adjustment
              const distance2 = (distance < deadzone) ? 0 : maxDistance / (maxDistance - deadzone) * (distance - deadzone);
              const xPosition2 = distance2 * Math.cos(angle);
              const yPosition2 = distance2 * Math.sin(angle);
              const xPercent = parseFloat((xPosition2 / maxDistance).toFixed(4));
              const yPercent = parseFloat((yPosition2 / maxDistance).toFixed(4));
              
              self.xPlace = xPercent;
              self.yPlace = yPercent;
              self.value = { x: self.xPlace, y: self.yPlace };
            }

          function handleUp(event) 
          {
            if ( !self.active ) return;

            // if this is a touch event, make sure it is the right one
            if (event.changedTouches && self.touchId != event.changedTouches[0].identifier) return;

            // transition the joystick position back to center
            stick.style.transition = '.2s';
            stick.style.transform = `translate3d(0px, 0px, 0px)`;

            // reset everything
            self.value = { x: 0, y: 0 };
            self.touchId = null;
            self.active = false;
            self.xPlace = 0;
            self.yPlace = 0;
          }

          stick.addEventListener('mousedown', handleDown);
          stick.addEventListener('touchstart', handleDown);
          document.addEventListener('mousemove', handleMove, {passive: false});
          document.addEventListener('touchmove', handleMove, {passive: false});
          document.addEventListener('mouseup', handleUp);
          document.addEventListener('touchend', handleUp);
        }
      }
      ///////////////////////////////////////////////////////////////////////

      let joystick1 = new JoystickController("stick1", 200, 8);

      function update()
      {
        //Left and Right
        if(joystick1.xPlace < -0.25 && joystick1.left == false){
          joystick1.right = false;
          socket.emit('leftOn', roomID);
          socket.emit('rightOff', roomID);
          joystick1.left = true;
        }
        if(joystick1.xPlace > 0.25 && joystick1.right == false){
          joystick1.left = false;
          socket.emit('rightOn', roomID);
          socket.emit('leftOff', roomID);
          joystick1.right = true;
        }
        if(joystick1.xPlace > -0.25 && joystick1.xPlace < 0.25 && (joystick1.left == true || joystick1.right == true)){
          joystick1.left = false;
          joystick1.right = false;
          socket.emit('rightOff', roomID);
          socket.emit('leftOff', roomID);
        }

        //Up and down
        if(joystick1.yPlace < -0.25 && joystick1.up == false){
          joystick1.down = false;
          socket.emit('upOn', roomID);
          socket.emit('downOff', roomID);
          joystick1.up = true;
        }
        if(joystick1.yPlace > 0.25 && joystick1.down == false){
          joystick1.up = false;
          socket.emit('downOn', roomID);
          socket.emit('upOff', roomID);
          joystick1.down = true;
        }
        if(joystick1.yPlace > -0.25 && joystick1.yPlace < 0.25 && (joystick1.up == true || joystick1.down == true)){
          joystick1.up = false;
          joystick1.down = false;
          socket.emit('upOff', roomID);
          socket.emit('downOff', roomID);
        }
      }

      function loop()
      {
        requestAnimationFrame(loop);
        update();
      }

      loop();

      //Function for when arrowkeys on the keyboard are pressed
      function buttondown(e) {
        if (e.key == 'ArrowLeft'){
          console.log('Left');
          document.getElementById("left").style.backgroundColor = "burlywood";
          socket.emit('left key down');
        }
        if (e.key == 'ArrowRight'){
          console.log('Right');
          document.getElementById("right").style.backgroundColor = "burlywood";
          socket.emit('right key down');
        }
        //alert("Key pressed: "+ e.key)
        //socket.emit('key down', e.key);
      }

      function buttonup(e) {
        if (e.key == 'ArrowLeft'){
          document.getElementById("left").style.backgroundColor = "cadetblue";
          socket.emit('left key up');
        }
        if (e.key == 'ArrowRight'){
          document.getElementById("right").style.backgroundColor = "cadetblue";
          socket.emit('right key up');
        }
        //alert("Key pressed: "+ e.key)
        //socket.emit('key up', e.key);
      }
    </script>
      <div id="footer"></div>
    </div>
  </body>
</html>