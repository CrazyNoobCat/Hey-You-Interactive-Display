<!DOCTYPE html>
<html lang="en">
  <head>
    <!--
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Slideshow | Hey You, Interact With Me!</title>

    <link rel="icon" href="logo/heyyou-fav.ico" sizes="any" />

    <!-- <link rel="manifest" href="/manifest.webmanifest"> -->

    <style>
      :root {
	  --slideshow-width:      1280px;
	  --slideshow-height:      720px;
	  --slideshow-negwidth:  -1280px;
	  --slideshow-negheight:  -720px;
	  
	  --animation-play-state:   running;
	  --animation-time:         10s;
	  --animation-currentslide: fromright-currentslide;
	  --animation-overlayslide: fromright-overlayslide;
      }
      
      body {
          display: flex;
          justify-content: center;
	  font-family: monospace;
	  color: #000000;
      }
      
    </style>

    <link rel="stylesheet" type="text/css" href="slideshow-animation.css"/>
    <link rel="stylesheet" type="text/css" href="slideshow-style.css"/>
    
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>    
    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script type="text/javascript" src="/socketCreation.js"></script>

    <script type="text/javascript" src="display-utils.js"></script>
    <script type="text/javascript" src="/scripts/slideshow-display.js"></script>
    
    <!-- Main script for website can be loaded here, should contain a socketUpdate function-->
    <script>
      // $(window).width() and window.height() are available from the get-go (i.e., don't need to wait for DOM ready)
      var viewportXDim = $(window).width();
      var viewportYDim = $(window).height();
      
      var SlideMaxXDim = viewportXDim * 0.9;
      var SlideMaxYDim = viewportYDim * 0.9;
      var QRDim = Math.max(viewportXDim * 0.12,250);

      // State variables for slideshow activity      
      var currentSlidePos = 0;
      var overlaySlidePos = 1;
      var currentSlideFS  = currentSlidePos + 1;
      var overlaySlideFS  = overlaySlidePos + 1;

      var slideDir  = null;
      var slideExt  = null;
      var numSlides = null;

      var actualSlideImageXDim = null;
      var actualSlideImageYDim = null;

      var displaySlideXDim = null;
      var displaySlideYDim = null;

      function loadSlideshow()
      {
	  slideDir = "/smoke-and-mirrors-sampler";
	  slideExt = ".PNG";
	  numSlides = 15;	  

	  actualSlideImageXDim = 1280;
	  actualSlideImageYDim = 720;

	  var scaleXDim = SlideMaxXDim / actualSlideImageXDim ;
	  var scaleYDim = SlideMaxYDim / actualSlideImageYDim ;

	  var scaleTransform;
	  
	  if (scaleXDim < scaleYDim) {
	      // Don't want to overflow, so scale by the smaller amount
	      displaySlideXDim = SlideMaxXDim;
	      displaySlideYDim = actualSlideImageYDim * scaleXDim;
	      //scaleTransform = "scale("+scaleXDim+","+scaleXDim+");";
	      scaleTransform = "scale("+scaleXDim+")";
	  }
	  else {
	      displaySlideXDim = actualSlideImageXDim * scaleYDim;
	      displaySlideYDim = SlideMaxYDim;
	      scaleTransform = "scale("+scaleYDim+")";
	  }
	  displaySlideXDim = Math.floor(displaySlideXDim);
	  displaySlideYDim = Math.floor(displaySlideYDim);

	  $('#currentslide-img').css("transform",scaleTransform);
	  $('#overlayslide-img').css("transform",scaleTransform);
	  
      }
      
      // Custom socketLoaded() for slideshow activity
      function socketLoaded(anyListener)
      {
          socket.onAny(anyListener); // Turns on the any listener
          socket.emit("displayLoaded"); 

          var displayHost = self.location.host;
	  var roomID    = getCookie('roomID');
	  var roomName  = getCookie('roomName');

	  displayRoomQRCode(displayHost,roomID,QRDim,"join-qrcode-left");
	  displayRoomQRCode(displayHost,roomID,QRDim,"join-qrcode-right");
	  
	  displayRoomURL(displayHost,roomName,"join-room-url-left");
	  displayRoomURL(displayHost,roomName,"join-room-url-right");
      } 

      function socketUpdate(e, ...args)
      {
	  if (e === "pause") {
	      var root = document.querySelector(':root');
	      root.style.setProperty('--animation-play-state', 'paused');
	    }
	  else if (e === "play") {
	      var root = document.querySelector(':root');
	      root.style.setProperty('--animation-play-state', 'running');
	  }
          else if (e === "next") {
	      startNextSlide("fromright");	      	      
          }
	  else if (e === "back") {
	      startPrevSlide("fromright");	      
          }
	  else if (e === "download") {
              console.log(args);
	      
	      var $currentSlideImg = $('#currentslide-img');
	      socket.emit('displayEmit', args[0], 'download', $currentSlideImg.attr("src") );
          }
	  else {
	      console.log("socketUpdate(): Unrecognized command '" + e + "'");
	  }
      }

      $(document).ready(function() {
	  $('#currentslide-img').css("width", displaySlideXDim+"px");
	  $('#currentslide-img').css("height",displaySlideYDim+"px");
	  $('#overlayslide-img').css("width", displaySlideXDim+"px");
	  $('#overlayslide-img').css("height",displaySlideYDim+"px");
	      
	  var root = document.querySelector(':root');
	  root.style.setProperty('--slideshow-width',      displaySlideXDim+'px');
	  root.style.setProperty('--slideshow-height',     displaySlideYDim+'px');
	  root.style.setProperty('--slideshow-negwidth',  -displaySlideXDim+'px');
	  root.style.setProperty('--slideshow-negheight', -displaySlideYDim+'px');
	  
	  // Set up first slide 
	  var $currentSlideImg = $('#currentslide-img');
	  var $overlaySlideImg = $('#overlayslide-img');
	  
	  $currentSlideImg.attr("src", slideDir + "/Slide" + currentSlideFS + slideExt);
	  $overlaySlideImg.attr("src", slideDir + "/Slide" + overlaySlideFS + slideExt);
	  
	  $currentSlideImg.on("load", function() {
	      $currentSlideImg.fadeIn(1000);
	      
	      if (numSlides > 1) {
		  // Get the next slide set up as the overlay, but need to wait until fadeIn done
		  setTimeout(() => { $overlaySlideImg.css("display", "block"); }, 1000);		  
		  
	      }	  	      
	  });

	  // https://stackoverflow.com/questions/6186454/is-there-a-callback-on-completion-of-a-css3-animation        
	  $("#currentslide-li").bind('animationend oanimationend webkitAnimationEnd MSAnimationEnd', function() { 
	      startNextSlide() 
	  });

	  doSlideTransition("fromright");        
      });

      // All displays need to defined a socketLoaded() function,
      // and call socketConnection("display") to kick things off

      setupConnection("display");
      loadSlideshow();
                  
    </script>
  </head>
  
  <body>

    <div class="container">
      <div id="content-showslide">
    	<div id="showslide">
          <div id="mask">
            <ul>
              <li id="currentslide-li" style="z-index: 0;">
		<img id="currentslide-img" style="display: none;"/>
              </li>
	      
              <li id="overlayslide-li" style="z-index: -1;">
		<img id="overlayslide-img" style="display: none;"/>
              </li>
            </ul>
	  </div>
	  <div id="progress-bar" class="progress-bar" style="display: none"></div>
        </div>
      </div>
      
    </div>
    
    <div id="join-left-container" style="width: 250px; display: block; position: absolute; left:   7px; bottom: 7px; z-index: 3; background-color: #eee; padding: 6px;">
      <div id="join-qrcode-div-left" style="position: relative; height: 250px;"><div id="join-qrcode-left"></div></div>
      <h3  id="join-room-url-left"   style="position: relative;"></h3>
    </div>
    <div id="join-right-container" style="width: 250px; display: block; position: absolute; right: 7px; bottom: 7px; z-index: 3; background-color: #eee; padding: 6px;">
      <div id="join-qrcode-div-right" style="position: relative; height: 250px;"><div id="join-qrcode-right"></div></div>      
      <h3  style="position: relative" id="join-room-url-right"></h3>
    </div>

    <footer>
      <script src="receiver.js"></script>
    </footer>

  </body>
</html>
