<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Slideshow | Hey You, Interact With Me!</title>

    <style>
      :root {
	  --animation-time:      10s;
	  --animation-baseslide: fromright-baseslide;
	  --animation-overlay:   fromright-overlay;
      }
      
      body {
          display: flex;
          justify-content: center;
      }

      video {
          display: none;
      }
/*      
      img {
          display: block;
      }
*/
      
    </style>

    <link rel="stylesheet" type="text/css" href="slideshow-animation.css"/>
    <link rel="stylesheet" type="text/css" href="slideshow-style.css"/>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>    
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="/socketCreation.js"></script>
    <!-- Main script for website can be loaded here, should contain a socketUpdate function-->
    <script>
        // Generic socket setup
        function socketLoaded(anyListener){
            vid = document.getElementById("video");
            slide = document.getElementById("baseslide-img");            

            socket.onAny(anyListener); // Turns on the any listener
            socket.emit("displayLoaded"); 

            vid.src = '/Slide16.mp4';
            vid.load();
            
            var displayHost = self.location.host;
            var url = 'https://api.qrserver.com/v1/create-qr-code/?data=' + displayHost + '/join/' + getCookie('roomID') + '&size=250x250';
	    var $imgL = $('<img>').attr('src',url);
	    var $imgR = $('<img>').attr('src',url);
	    
            $('#barcodeL').html($imgL)
            $('#barcodeR').html($imgR)
        } 
            
        setupConnection("display");  

      //var slideDir = "";
      //var slideExt = ".JPG";
      var slideDir = "/smoke-and-mirrors-sampler";
      var slideExt = ".PNG";
      
      var currentSlide = 1;
      var maxSlides = 16;
      
      var vid;
      var slide;
      
        function socketUpdate(e, ...args){
            if (e === "next"){
                if (currentSlide < maxSlides)
                    currentSlide++;
                else 
                    currentSlide = 1;

                if (currentSlide == 16){
                    slide.style.display = 'none';
                    vid.style.display = 'block';
                    socket.emit('displayEmit', getCookie('roomID'), 'audio', 'play');
                    vid.play();
                } else{
                    if (vid.style.display === 'block'){
                        vid.style.display = 'none';
                        slide.style.display = 'block'
                        socket.emit('displayEmit', getCookie('roomID'), 'audio', 'reset');
                        vid.load();
                    }
                    slide.src = slideDir + "/Slide" + currentSlide + slideExt; 
                } 

            } else if (e ==="back"){
                if (currentSlide > 1)
                    currentSlide--;
                else 
                    currentSlide = maxSlides;

                if (currentSlide == 16){
                    slide.style.display = 'none';
                    vid.style.display = 'block';
                    socket.emit('displayEmit', getCookie('roomID'), 'audio', 'play');
                    vid.play();
                } else{
                    if (vid.style.display === 'block'){
                        vid.style.display = 'none';
                        slide.style.display = 'block'
                        socket.emit('displayEmit', getCookie('roomID'), 'audio', 'reset');
                        vid.load();
                    }
                    slide.src = slideDir + "/Slide" + currentSlide + slideExt;  

                }
                

            } else if (e === "max"){
                maxSlides = args[0];
            } else if (e ==="download"){
                console.log(args);
                if (currentSlide == 16)
                    socket.emit('displayEmit', args[0], 'download', vid.src );
                else
                    socket.emit('displayEmit', args[0], 'download', slide.src );
            }
        }


      var overlayImagePos = 2;
      
      function doSlideTransition(transitionType)
      {
	  //console.log("doTransition() called");

	  var root = document.querySelector(':root');
	  //root.style.setProperty('--animation-time', '2s');
	  root.style.setProperty('--animation-baseslide', transitionType+'-baseslide');
	  root.style.setProperty('--animation-overlay',   transitionType+'-overlay');
	  
	  document.getElementById("baseslide-li").classList.add("baseslide-animation");
	  document.getElementById("overlay-li").classList.add("overlay-animation");
	  var progressBar = document.getElementById("progress-bar");
	  progressBar.style.display = "block";
	  progressBar.classList.add("progress-bar-animate");

      }

      function slideAnimationReset()
      {
	  //console.log("slideAnimationReset() called");
	  
	  //document.getElementById("baseslide-img").src="images/"+images[overlayImagePos];
	  document.getElementById("baseslide-img").src = slideDir + "/Slide" + overlayImagePos + slideExt;
	  
	  //overlayImagePos = (overlayImagePos + 1) % images.length;
	  overlayImagePos = (overlayImagePos + 1) % maxSlides;

	  if (overlayImagePos < maxSlides) {
	      //document.getElementById("overlay-img").src="images/"+images[overlayImagePos];
	      document.getElementById("overlay-img").src = slideDir + "/Slide" + overlayImagePos + slideExt;
	  }
	  
	  document.getElementById("baseslide-li").classList.remove("baseslide-animation");
	  document.getElementById("overlay-li").classList.remove("overlay-animation");
	  document.getElementById("progress-bar").classList.remove("progress-bar-animate");
      }

      
      $(document).ready(function() {
	  // Set up first slide 
	  var $baseSlide = $('#baseslide-img');
	  var $overlaySlide = $('#overlay-img');
	  
	  $baseSlide.attr("src", slideDir + "/Slide" + currentSlide + slideExt);
	  $overlaySlide.attr("src", slideDir + "/Slide" + overlayImagePos + slideExt);

	  $baseSlide.on("load", function() {
	      $baseSlide.fadeIn(1000);
	      
	      if (maxSlides > 1) {
		  // Get the next slide set up as the overlay, but need to wait until fadeIn done
		  setTimeout(() => { $overlaySlide.css("display", "block"); }, 1000);		  

	      }	  	      
	  });
      });
      
    </script>

  </head>
  <body>

    <div class="container">
      <div id="content-showslide">
    	<div id="showslide">
          <div id="mask">
            <ul>
              <li id="baseslide-li" style="z-index: 0;">
		<img id="baseslide-img" style="display: none;"/>
              </li>
	      
              <li id="overlay-li" style="z-index: -1;">
		<img id="overlay-img" style="display: none;"/>
              </li>
            </ul>
	  </div>
	  <div id="progress-bar" class="progress-bar" style="display: none"></div>
        </div>
      </div>

      <button onclick="doSlideTransition('fromright')">From Right Transition</button>
      <button onclick="doSlideTransition('crossfade')">Cross-fade Transition</button>
      <script>
	// https://stackoverflow.com/questions/6186454/is-there-a-callback-on-completion-of-a-css3-animation
	
	// $("#sun").bind('oanimationend animationend webkitAnimationEnd', function() { 
	//  alert("fin") 
	// });
	var element = document.getElementById("baseslide-li");
	element.addEventListener("webkitAnimationEnd", slideAnimationReset,false);
	element.addEventListener("animationend",       slideAnimationReset,false);
	element.addEventListener("oanimationend",      slideAnimationReset,false);
	element.addEventListener("MSAnimationEnd",     slideAnimationReset,false);
      </script>
    </div>
    <!--
    <img id="slideshow" style="display: none;"/>
    -->
    
    <video id='video' width="500px" height="500px" muted >           
      <source id='video' type="video/mp4"> 
    </video>

    <div id="barcodeL" style="height: 250px; display: block; position: absolute; left:  7px; top: 7px;"></div>
    <div id="barcodeR" style="height: 250px; display: block; position: absolute; right: 7px; top: 7px;"></div>

    <footer>
        <script src="receiver.js"></script>
    </footer>
</body>
</html>
